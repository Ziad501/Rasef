@page "/gis"
@layout Rasef.Components.Layout.EmptyLayout

<div class="min-vh-100 d-flex flex-column">
    <!-- Topbar -->
    <nav class="navbar navbar-expand-lg navbar-dark shadow-sm gis-topbar">
        <div class="container-fluid px-3">
            <a class="navbar-brand d-flex align-items-center" href="/menu">
                <div class="logo-container rounded-circle p-2">
                    <img src="/css/img/logo.png" alt="راصف" height="32" />
                </div>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="topNav">
                <div class="d-flex flex-wrap gap-2 me-auto ms-lg-3 mt-2 mt-lg-0">
                    <a href="/home" class="btn btn-sm px-3 nav-btn">
                        <i class="bi bi-house-door me-1"></i> الرئيسية
                    </a>
                    <a href="/gis" class="btn btn-sm px-3 nav-btn active">
                        <i class="bi bi-map me-1"></i> GIS
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Map area -->
    <div class="gis-wrapper position-relative flex-grow-1">
        <div id="mapView" class="gis-map"></div>

        <!-- Single upper-left search -->
        <div id="leftStreetAnchor" class="left-street-anchor"></div>

        <!-- RIGHT: small top tray -->
        <div class="gis-right-toptray shadow">
            <button id="btnBasemap" class="tray-btn" title="خرائط أساس"><i class="bi bi-grid-3x3-gap"></i></button>
            <button id="btnLegend" class="tray-btn" title="المفتاح"><i class="bi bi-list-task"></i></button>
        </div>

        <!-- RIGHT: vertical tools beside the layer panel -->
        <div class="gis-right-tools shadow">
            <button id="btnToggleLayerPanel" class="tool-btn" title="فتح"><i class="bi bi-chevron-double-right"></i></button>
            <button id="btnFilter1" class="tool-btn" title="فلتر"><i class="bi bi-funnel"></i></button>
            <button id="btnFilter2" class="tool-btn" title="فلتر"><i class="bi bi-funnel"></i></button>
        </div>

        <!-- RIGHT: layers list -->
        <div id="layerPanel" class="gis-layer-panel shadow">
            <div id="layerListContainer"></div>
        </div>

        <!-- Popovers -->
        <div id="basemapPopover" class="gis-popover shadow d-none"></div>
        <div id="legendPopover" class="gis-popover shadow d-none"></div>
    </div>
</div>

<link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />

<script>
    (function () {
      "use strict";

      let currentLang = "AR";

      // --- helpers -----------------------------------------------------
      const qs = (id) => document.getElementById(id);
      const toggle = (el) => el.classList.toggle("d-none");

      function loadArcGIS(callback) {
        if (window.require) { callback(); return; }
        const s = document.createElement("script");
        s.src = "https://js.arcgis.com/4.29/";
        s.onload = callback;
        document.head.appendChild(s);
      }

      // --- main init ---------------------------------------------------
      function init() {
        require([
          "esri/Map","esri/views/MapView",
          "esri/widgets/Zoom","esri/widgets/Home","esri/widgets/Locate","esri/widgets/ScaleBar",
          "esri/widgets/BasemapGallery","esri/widgets/Legend",
          "esri/widgets/Search","esri/widgets/Compass",
          "esri/config","esri/geometry/Extent","esri/geometry/Point"
        ], function (
          Map, MapView,
          Zoom, Home, Locate, ScaleBar,
          BasemapGallery, Legend,
          Search, Compass,
          esriConfig, Extent, Point
        ) {

          if (window.__ESRI_API_KEY) esriConfig.apiKey = window.__ESRI_API_KEY;

          // Map + view
          const map  = new Map({ basemap: "satellite" });
          const view = new MapView({
            container: "mapView",
            map,
            center: [39.197, 21.543],
            zoom: 11,
            ui: { components: [] },
            constraints: { rotationEnabled: true },
            padding: { top: 0 } // dynamic later
          });

          // Jeddah extent for search bias
          const jeddahExtent = new Extent({
            xmin: 38.95, ymin: 21.30, xmax: 39.55, ymax: 21.75, spatialReference: 4326
          });

          // Keep widgets clear of the top navbar – also expose CSS var for height
          function applyTopPadding() {
            const nav = document.querySelector(".gis-topbar");
            const h = nav ? nav.offsetHeight : 64;
            view.padding = { top: h, left: 0, right: 0, bottom: 0 };
            document.documentElement.style.setProperty("--gis-nav-h", `${h}px`);
          }

          // Built-in widgets (left)
          view.ui.add(new Zoom({ view }),    "top-left");
          view.ui.add(new Home({ view }),    "top-left");
          view.ui.add(new Locate({ view }),  "top-left");
          view.ui.add(new Compass({ view }), "top-left");
          view.ui.add(new ScaleBar({ view, unit: "metric" }), "bottom-left");

          // Search (left)
          const generalSearch = new Search({
            view,
            container: "leftStreetAnchor",
            includeDefaultSources: true,
            suggestionsEnabled: true,
            searchAllEnabled: true,
            locationEnabled: true,
            searchExtent: jeddahExtent,
            location: new Point({ longitude: 39.197, latitude: 21.543 })
          });

          // ---------- Static (UI-only) layer list ----------
          const STATIC_LAYERS = [
            { title: "البلاغات", visible: true },
            { title: "طبقة تقييم الشوارع الرئيسية", visible: true },
            { title: "طبقة تقييم الشوارع الفرعية", visible: true },
            { title: "طبقة المقاطع", visible: true },
            { title: "طبقة الشوارع الفرعية", visible: true },
            { title: "طبقة تقييم المناطق", visible: true },
            { title: "طبقة المناطق", visible: true },
            { title: "طبقة الاحياء", visible: true },
            { title: "طبقة البلديات", visible: true }
          ];

          view.when(() => {
            // Build the layer list
            const container = qs("layerListContainer");
            container.innerHTML = STATIC_LAYERS.map((layer, i) => `
              <div class="custom-layer-item" data-index="${i}">
                <div class="layer-item-content">
                  <button class="layer-toggle-btn" data-visible="${layer.visible}">
                    <i class="bi ${layer.visible ? "bi-eye" : "bi-eye-slash"}"></i>
                  </button>
                  <span class="layer-title">${layer.title}</span>
                  <div class="layer-indicator ${layer.visible ? "visible" : ""}"></div>
                </div>
              </div>
            `).join("");

            // Toggle visibility (UI only)
            container.addEventListener("click", (e) => {
              const btn  = e.target.closest(".layer-toggle-btn");
              if (!btn) return;

              const item   = btn.closest(".custom-layer-item");
              const index  = parseInt(item.dataset.index, 10);
              const state  = STATIC_LAYERS[index].visible = !STATIC_LAYERS[index].visible;
              const icon   = btn.querySelector("i");
              const dot    = item.querySelector(".layer-indicator");

              icon.className = state ? "bi bi-eye" : "bi bi-eye-slash";
              dot.classList.toggle("visible", state);
              btn.dataset.visible = String(state);
            });

            // Popovers (right)
            const basePopover   = qs("basemapPopover");
            const legendPopover = qs("legendPopover");
            new BasemapGallery({ view, container: basePopover });
            new Legend({ view, container: legendPopover });

            qs("btnBasemap").onclick = () => { legendPopover.classList.add("d-none"); toggle(basePopover); };
            qs("btnLegend").onclick  = () => { basePopover.classList.add("d-none");  toggle(legendPopover); };

            document.addEventListener("click", (e) => {
              const ids = ["btnBasemap","basemapPopover","btnLegend","legendPopover"];
              const clickedInside = ids.some(id => e.target.closest && e.target.closest("#" + id));
              if (!clickedInside) { basePopover.classList.add("d-none"); legendPopover.classList.add("d-none"); }
            });

            // Layer panel toggle
            const panel     = qs("layerPanel");
            const toggleBtn = qs("btnToggleLayerPanel");
            const icon      = toggleBtn.querySelector("i");

            toggleBtn.onclick = () => {
              panel.classList.toggle("collapsed");
              icon.className = panel.classList.contains("collapsed")
                ? "bi bi-chevron-double-left"
                : "bi bi-chevron-double-right";
            };

            // Additional top padding based on the left search anchor height
            function setTopPaddingFromSearch() {
              const anchor = document.querySelector(".left-street-anchor");
              const h = anchor ? anchor.offsetHeight : 0;
              view.padding = { top: Math.max(60, h + 16), left: 0, right: 0, bottom: 0 };
            }

            // Responsive panel behavior
            function setPanelForBreakpoint() {
              const isTablet = window.innerWidth <= 992;
              const isMobile = window.innerWidth <= 576;
              if (isTablet || isMobile) {
                panel.classList.add("collapsed");
                icon.className = "bi bi-chevron-double-left";
              }
              setTopPaddingFromSearch();
            }

            // First layout pass + listeners
            applyTopPadding();
            setPanelForBreakpoint();
            window.addEventListener("resize", applyTopPadding);
            window.addEventListener("resize", setPanelForBreakpoint);
          });

          // Language toggle (optional – guarded)
          function setLang(lang) {
            currentLang = lang;
            const label = qs("langLabel");
            if (label) label.textContent = lang;

            generalSearch.allPlaceholder = (lang === "AR")
              ? "ابحث عن عنوان أو مكان"
              : "Find address or place";
          }
          const langBtn = qs("langBtn");
          if (langBtn) langBtn.onclick = () => setLang(currentLang === "AR" ? "EN" : "AR");
          setLang("AR");
        });
      }

      loadArcGIS(init);
    })();
</script>
