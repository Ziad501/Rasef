@page "/workorder/create"
@layout MainLayout
@using System.ComponentModel.DataAnnotations
@inject NavigationManager Nav

@code {
    [CascadingParameter] public string CurrentLanguage { get; set; } = "AR";
    private string activeTab = "general";

    private readonly Dictionary<string, Dictionary<string, string>> t = new()
    {
        ["AR"] = new()
        {
            ["title"] = "إنشاء أمر عمل جديد",
            ["subtitle"] = "أدخل بيانات أمر العمل الجديد",
            ["back"] = "رجوع",
            ["saveClose"] = "حفظ وإغلاق",
            ["saveKeep"] = "حفظ ومتابعة",
            ["delete"] = "حذف",
            ["general"] = "عام",
            ["attachments"] = "المرفقات",
            ["workflowHistory"] = "سجل سير العمل",
            ["streetInfo"] = "معلومات الشارع",
            ["streetCategory"] = "تصنيف الشارع",
            ["mainStreet"] = "شارع رئيسي",
            ["subStreet"] = "شارع فرعي",
            ["municipality"] = "البلدية",
            ["selectMunicipality"] = "-- اختر البلدية --",
            ["mainDistrict"] = "الحي الرئيسي",
            ["selectDistrict"] = "-- اختر الحي --",
            ["subDistrict"] = "الحي الفرعي",
            ["street"] = "الشارع",
            ["streetNos"] = "أرقام الشوارع",
            ["sector"] = "القطاع (رئيسي)",
            ["sectionNo"] = "رقم المقطع (فرعي)",
            ["addLane"] = "إضافة مسار",
            ["laneNo"] = "رقم المسار",
            ["laneType"] = "نوع المسار",
            ["removeLane"] = "إزالة",
            ["workOrderType"] = "نوع أمر العمل",
            ["selectType"] = "-- اختر --",
            ["orderDates"] = "تواريخ الأمر",
            ["workOrderDate"] = "تاريخ أمر العمل",
            ["workOrderEndDate"] = "تاريخ انتهاء أمر العمل",
            ["workOrderRenewDate"] = "تاريخ تجديد أمر العمل",
            ["projectInfo"] = "معلومات المشروع",
            ["assignTo"] = "تعيين إلى",
            ["projectRef"] = "مرجع المشروع",
            ["contractNumber"] = "رقم العقد/الارتباط",
            ["siteLocation"] = "موقع الموقع",
            ["workDuration"] = "مدة العمل",
            ["durationHelp"] = "يجب تقدير مدة العمل بالأيام",
            ["warranty"] = "الضمان",
            ["yearsOfLife"] = "سنوات العمر",
            ["warrantyStartDate"] = "تاريخ بدء الضمان",
            ["warrantyEndDate"] = "تاريخ انتهاء الضمان",
            ["additionalInfo"] = "معلومات إضافية",
            ["equipment"] = "المعدات",
            ["addEquipment"] = "إضافة معدات",
            ["equipmentName"] = "اسم المعدات",
            ["quantity"] = "الكمية",
            ["itemFix"] = "الإصلاحات",
            ["addFix"] = "إضافة إصلاح",
            ["fixName"] = "اسم الإصلاح",
            ["fixDescription"] = "وصف الإصلاح",
            ["boqItems"] = "عناصر BOQ",
            ["addBoqItem"] = "إضافة عنصر BOQ",
            ["itemDesc"] = "وصف العنصر",
            ["itemCode"] = "كود العنصر",
            ["unit"] = "الوحدة",
            ["qty"] = "الكمية",
            ["prevExec"] = "التنفيذ السابق",
            ["execQty"] = "كمية التنفيذ",
            ["actions"] = "الإجراءات",
            ["noItems"] = "لا توجد عناصر",
            ["workOrderNotes"] = "ملاحظات أمر العمل",
            ["notesPlaceholder"] = "ضع ملاحظات تفصيلية عن العمل...",
            ["attachmentsTitle"] = "المرفقات",
            ["projectPlan"] = "خطة المشروع",
            ["selectFile"] = "اختر ملف",
            ["imageBefore"] = "صورة قبل",
            ["imageAfter"] = "صورة بعد",
            ["mapKey"] = "مفتاح الخريطة",
            ["otherDoc"] = "مستند آخر",
            ["followWorkflow"] = "متابعة سير العمل",
            ["workflowHistoryTitle"] = "سجل سير العمل",
            ["stage"] = "المرحلة",
            ["actionBy"] = "الإجراء بواسطة",
            ["actionDate"] = "تاريخ الإجراء",
            ["status"] = "الحالة",
            ["comments"] = "التعليقات",
            ["noHistory"] = "لا يوجد سجل",
            ["Normal"] = "عادي",
            ["ExceptionPriority"] = "استثناء أولوية",
            ["ExceptionEmergency"] = "استثناء طارئ",
            ["required"] = "هذا الحقل مطلوب"
        },
        ["EN"] = new()
        {
            ["title"] = "New Work Order",
            ["subtitle"] = "Enter new work order information",
            ["back"] = "Back",
            ["saveClose"] = "Save & Close",
            ["saveKeep"] = "Save & Keep",
            ["delete"] = "Delete",
            ["general"] = "General",
            ["attachments"] = "Attachments",
            ["workflowHistory"] = "Workflow History",
            ["streetInfo"] = "Street Information",
            ["streetCategory"] = "Street Category",
            ["mainStreet"] = "Main Street",
            ["subStreet"] = "Sub Street",
            ["municipality"] = "Municipality",
            ["selectMunicipality"] = "-- Select Municipality --",
            ["mainDistrict"] = "Main District",
            ["selectDistrict"] = "-- Select District --",
            ["subDistrict"] = "Sub-District",
            ["street"] = "Street",
            ["streetNos"] = "Street Numbers",
            ["sector"] = "Sector (Main)",
            ["sectionNo"] = "Section No (Sub)",
            ["addLane"] = "Add Lane",
            ["laneNo"] = "Lane No",
            ["laneType"] = "Lane Type",
            ["removeLane"] = "Remove",
            ["workOrderType"] = "Work Order Type",
            ["selectType"] = "-- Select --",
            ["orderDates"] = "Order Dates",
            ["workOrderDate"] = "Work Order Date",
            ["workOrderEndDate"] = "Work Order End Date",
            ["workOrderRenewDate"] = "Work Order Renew Date",
            ["projectInfo"] = "Project Information",
            ["assignTo"] = "Assign To",
            ["projectRef"] = "Project Ref",
            ["contractNumber"] = "Contract Number",
            ["siteLocation"] = "Site Location",
            ["workDuration"] = "Work Duration",
            ["durationHelp"] = "Work Duration Should be Estimated in Days",
            ["warranty"] = "Warranty",
            ["yearsOfLife"] = "Years Of Life",
            ["warrantyStartDate"] = "Warranty Start Date",
            ["warrantyEndDate"] = "Warranty End Date",
            ["additionalInfo"] = "Additional Information",
            ["equipment"] = "Equipment",
            ["addEquipment"] = "Add Equipment",
            ["equipmentName"] = "Equipment Name",
            ["quantity"] = "Quantity",
            ["itemFix"] = "Fixes",
            ["addFix"] = "Add Fix",
            ["fixName"] = "Fix Name",
            ["fixDescription"] = "Fix Description",
            ["boqItems"] = "BOQ Items",
            ["addBoqItem"] = "Add BOQ Item",
            ["itemDesc"] = "Item Desc",
            ["itemCode"] = "Item Code",
            ["unit"] = "Unit",
            ["qty"] = "Qty",
            ["prevExec"] = "Prev Exec",
            ["execQty"] = "Exec Qty",
            ["actions"] = "Actions",
            ["noItems"] = "No items",
            ["workOrderNotes"] = "Work Order Notes",
            ["notesPlaceholder"] = "Put detailed notes about the work...",
            ["attachmentsTitle"] = "Attachments",
            ["projectPlan"] = "Project Plan",
            ["selectFile"] = "Select File",
            ["imageBefore"] = "Image Before",
            ["imageAfter"] = "Image After",
            ["mapKey"] = "Map Key",
            ["otherDoc"] = "Other Document",
            ["followWorkflow"] = "Follow up Workflow History",
            ["workflowHistoryTitle"] = "Workflow History",
            ["stage"] = "Stage",
            ["actionBy"] = "Action By",
            ["actionDate"] = "Action Date",
            ["status"] = "Status",
            ["comments"] = "Comments",
            ["noHistory"] = "No history",
            ["Normal"] = "Normal",
            ["ExceptionPriority"] = "Exception Priority",
            ["ExceptionEmergency"] = "Exception Emergency",
            ["required"] = "This field is required"
        }
    };
    string T(string k) => t[CurrentLanguage].TryGetValue(k, out var v) ? v : k;

    private WorkOrderForm model = new();

    private void Submit()
    {
        Nav.NavigateTo("/workorder/workflow");
    }

    private void AddLane()
    {
        model.Lanes.Add(new LaneForm { LaneNo = (model.Lanes.Count + 1).ToString(), Type = "Normal" });
    }

    private void RemoveLane(LaneForm lane)
    {
        model.Lanes.Remove(lane);
    }

    private void AddEquipment()
    {
        model.Equipment.Add(new EquipmentForm());
    }

    private void RemoveEquipment(EquipmentForm eq)
    {
        model.Equipment.Remove(eq);
    }

    private void AddFix()
    {
        model.Fixes.Add(new FixForm());
    }

    private void RemoveFix(FixForm fix)
    {
        model.Fixes.Remove(fix);
    }

    private void AddBoqItem()
    {
        model.BoqItems.Add(new BoqItemForm());
    }

    private void RemoveBoqItem(BoqItemForm item)
    {
        model.BoqItems.Remove(item);
    }

    public class WorkOrderForm
    {
        public string StreetCategory { get; set; } = "Sub";
        public string Municipality { get; set; } = "";
        public string MainDistrict { get; set; } = "";
        public string SubDistrict { get; set; } = "";
        public string SingleStreetNo { get; set; } = "";
        public string SelectedStreetNos { get; set; } = "";
        public string Sector { get; set; } = "";
        public string SectionNo { get; set; } = "";
        public List<LaneForm> Lanes { get; set; } = new();

        [Required(ErrorMessage = "Required")]
        public string Type { get; set; } = "";
        public DateTime? WorkOrderDate { get; set; }
        public DateTime? WorkOrderEndDate { get; set; }
        public DateTime? WorkOrderRenewDate { get; set; }
        public string AssignTo { get; set; } = "";
        public string ProjectRef { get; set; } = "";
        public string ContractNumber { get; set; } = "";
        public string SiteLocation { get; set; } = "";
        public int? WorkDuration { get; set; }
        public int? YearsOfLife { get; set; }
        public DateTime? WarrantyEndDate { get; set; }
        public DateTime? WarrantyStartDate { get; set; }
        public List<EquipmentForm> Equipment { get; set; } = new();
        public List<FixForm> Fixes { get; set; } = new();
        public List<BoqItemForm> BoqItems { get; set; } = new();
        public string WorkOrderNotes { get; set; } = "";
    }

    public class LaneForm
    {
        public string LaneNo { get; set; } = "";
        public string Type { get; set; } = "Normal";
    }

    public class EquipmentForm
    {
        public string Name { get; set; } = "";
        public int Quantity { get; set; } = 1;
    }

    public class FixForm
    {
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
    }

    public class BoqItemForm
    {
        public string Desc { get; set; } = "";
        public string Code { get; set; } = "";
        public string Unit { get; set; } = "";
        public decimal Qty { get; set; }
        public decimal PrevExec { get; set; }
        public decimal ExecQty { get; set; }
    }
}

<!-- NOTE: force dark for this page; if you have a global toggle, remove these attributes and set them on <body> -->
<div dir="@(CurrentLanguage == "AR" ? "rtl" : "ltr")">


    <div class="mb-3">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
            <div class="d-flex align-items-center gap-2">
                <a href="/workorder/workflow" class="btn btn-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="bi bi-arrow-@(CurrentLanguage == "AR" ? "right" : "left")"></i>
                </a>
                <div>
                    <h5 class="m-0 fw-bold text-primary">@T("title")</h5>
                    <p class="text-muted small mb-0">@T("subtitle")</p>
                </div>
            </div>
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-primary btn-sm" @onclick="Submit">
                    <i class="bi bi-floppy me-1"></i> @T("saveClose")
                </button>
                <button class="btn btn-success btn-sm" @onclick="Submit">
                    <i class="bi bi-check-circle me-1"></i> @T("saveKeep")
                </button>
                <button class="btn btn-danger btn-sm">
                    <i class="bi bi-trash me-1"></i> @T("delete")
                </button>
            </div>
        </div>
    </div>

    <div class="card mb-3 border-0 shadow-sm">
        <div class="card-header bg-body-secondary border-bottom">
            <ul class="nav nav-tabs card-header-tabs border-0">
                <li class="nav-item">
                    <button class="nav-link @(activeTab == "general" ? "active" : "") border-0 d-flex align-items-center gap-2" @onclick='() => activeTab = "general"'>
                        <i class="bi bi-info-circle"></i> @T("general")
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(activeTab == "attachments" ? "active" : "") border-0 d-flex align-items-center gap-2" @onclick='() => activeTab = "attachments"'>
                        <i class="bi bi-paperclip"></i> @T("attachments")
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(activeTab == "workflow" ? "active" : "") border-0 d-flex align-items-center gap-2" @onclick='() => activeTab = "workflow"'>
                        <i class="bi bi-clock-history"></i> @T("workflowHistory")
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <EditForm Model="model" OnValidSubmit="Submit">
        <DataAnnotationsValidator />

        @if (activeTab == "general")
        {
            <div class="p-3">
                <!-- Street Information -->
                <div class="card mb-4 border shadow-sm">
                    <div class="card-header bg-primary-subtle d-flex align-items-center gap-2">
                        <i class="bi bi-signpost-2 fs-5"></i>
                        <span class="fw-bold">@T("streetInfo")</span>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label fw-semibold small text-uppercase">@T("streetCategory") *</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="streetCategory" id="catMain" value="Main" @onchange='() => model.StreetCategory = "Main"' checked="@(model.StreetCategory == "Main")" />
                                    <label class="btn btn-outline-primary" for="catMain">@T("mainStreet")</label>
                                    <input type="radio" class="btn-check" name="streetCategory" id="catSub" value="Sub" @onchange='() => model.StreetCategory = "Sub"' checked="@(model.StreetCategory == "Sub")" />
                                    <label class="btn btn-outline-primary" for="catSub">@T("subStreet")</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold small text-uppercase">@T("municipality") *</label>
                                <select class="form-select" @bind="model.Municipality">
                                    <option value="">@T("selectMunicipality")</option>
                                    <option value="jeddah">جدة / Jeddah</option>
                                    <option value="mecca">مكة / Mecca</option>
                                    <option value="riyadh">الرياض / Riyadh</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold small text-uppercase">@T("mainDistrict") *</label>
                                <select class="form-select" @bind="model.MainDistrict">
                                    <option value="">@T("selectDistrict")</option>
                                    <option value="alsalamah">Al-Salamah</option>
                                    <option value="alrawdah">Al-Rawdah</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold small text-uppercase">@T("subDistrict")</label>
                                <input type="text" class="form-control" @bind="model.SubDistrict" placeholder="Block A" />
                            </div>

                            @if (model.StreetCategory == "Sub")
                            {
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small text-uppercase">@T("streetNos")</label>
                                    <input type="text" class="form-control" @bind="model.SelectedStreetNos" placeholder="101, 102, 103" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small text-uppercase">@T("sectionNo")</label>
                                    <input type="text" class="form-control" @bind="model.SectionNo" />
                                </div>
                            }
                            else
                            {
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small text-uppercase">@T("street")</label>
                                    <input type="text" class="form-control" @bind="model.SingleStreetNo" placeholder="1001" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small text-uppercase">@T("sector")</label>
                                    <input type="text" class="form-control" @bind="model.Sector" placeholder="Sector-1" />
                                </div>

                                <div class="col-12">
                                    <div class="p-3 bg-body-secondary border rounded-3">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <label class="form-label fw-semibold mb-0">@T("laneType")</label>
                                            <button type="button" class="btn btn-primary btn-sm" @onclick="AddLane">
                                                <i class="bi bi-plus-circle me-1"></i> @T("addLane")
                                            </button>
                                        </div>
                                        @if (model.Lanes.Count == 0)
                                        {
                                            <div class="text-center text-muted py-5">
                                                <i class="bi bi-inbox display-1 opacity-25"></i>
                                                <p class="mt-2">@T("noItems")</p>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="d-flex flex-column gap-2">
                                                @foreach (var lane in model.Lanes)
                                                {
                                                    <!-- CHANGED: bg-white -> bg-surface so it adapts in dark -->
                                                    <div class="d-flex gap-2 p-3 bg-body border rounded-2 align-items-end">
                                                        <div style="min-width: 120px;">
                                                            <label class="form-label small fw-semibold text-muted">@T("laneNo")</label>
                                                            <input type="text" class="form-control form-control-sm" @bind="lane.LaneNo" />
                                                        </div>
                                                        <div class="flex-grow-1">
                                                            <label class="form-label small fw-semibold text-muted">@T("laneType")</label>
                                                            <select class="form-select form-select-sm" @bind="lane.Type">
                                                                <option value="Normal">@T("Normal")</option>
                                                                <option value="ExceptionPriority">@T("ExceptionPriority")</option>
                                                                <option value="ExceptionEmergency">@T("ExceptionEmergency")</option>
                                                            </select>
                                                        </div>
                                                        <button type="button" class="btn btn-danger btn-sm" @onclick="() => RemoveLane(lane)">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Work Order Type -->
                <div class="card mb-4 border shadow-sm">
                    <div class="card-header bg-primary-subtle d-flex align-items-center gap-2">
                        <i class="bi bi-tag fs-5"></i>
                        <span class="fw-bold">@T("workOrderType")</span>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold small text-uppercase">@T("workOrderType") *</label>
                                <select class="form-select" @bind="model.Type">
                                    <option value="">@T("selectType")</option>
                                    <option value="Normal">@T("Normal")</option>
                                    <option value="ExceptionPriority">@T("ExceptionPriority")</option>
                                    <option value="ExceptionEmergency">@T("ExceptionEmergency")</option>
                                </select>
                                <ValidationMessage For="() => model.Type" class="text-danger small" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Dates -->
                <div class="card mb-4 border shadow-sm">
                    <div class="card-header bg-primary-subtle d-flex align-items-center gap-2">
                        <i class="bi bi-calendar3 fs-5"></i>
                        <span class="fw-bold">@T("orderDates")</span>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold small text-uppercase">@T("workOrderDate") *</label>
                                <input type="date" class="form-control" @bind="model.WorkOrderDate" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold small text-uppercase">@T("workOrderEndDate") *</label>
                                <input type="date" class="form-control" @bind="model.WorkOrderEndDate" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold small text-uppercase">@T("workOrderRenewDate")</label>
                                <input type="date" class="form-control" @bind="model.WorkOrderRenewDate" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Project Information -->
                <div class="card mb-4 border shadow-sm">
                    <div class="card-header bg-primary-subtle d-flex align-items-center gap-2">
                        <i class="bi bi-folder2-open fs-5"></i>
                        <span class="fw-bold">@T("projectInfo")</span>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold small text-uppercase">@T("assignTo") *</label>
                                <select class="form-select" @bind="model.AssignTo">
                                    <option value="">@T("selectType")</option>
                                    <option value="consultant-a">Consultant A</option>
                                    <option value="consultant-b">Consultant B</option>
                                    <option value="consultant-c">Consultant C</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold small text-uppercase">@T("projectRef") *</label>
                                <select class="form-select" @bind="model.ProjectRef">
                                    <option value="">@T("selectType")</option>
                                    <option value="road2025">Road Maintenance 2025</option>
                                    <option value="bridge2025">Bridge Repair 2025</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold small text-uppercase">@T("contractNumber")</label>
                                <input type="text" class="form-control" @bind="model.ContractNumber" placeholder="CNT-2025-001" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold small text-uppercase">@T("siteLocation") *</label>
                                <input type="text" class="form-control" @bind="model.SiteLocation" placeholder="Prince Mohammed Bin Abdulaziz St." />
                            </div>
                            <div class="col-md-12">
                                <label class="form-label fw-semibold small text-uppercase">@T("workDuration") *</label>
                                <input type="number" class="form-control" @bind="model.WorkDuration" placeholder="45" />
                                <div class="form-text fst-italic">@T("durationHelp")</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Warranty -->
                <div class="card mb-4 border shadow-sm">
                    <div class="card-header bg-primary-subtle d-flex align-items-center gap-2">
                        <i class="bi bi-shield-check fs-5"></i>
                        <span class="fw-bold">@T("warranty")</span>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold small text-uppercase">@T("yearsOfLife")</label>
                                <input type="number" class="form-control" @bind="model.YearsOfLife" placeholder="2" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold small text-uppercase">@T("warrantyStartDate")</label>
                                <input type="date" class="form-control" @bind="model.WarrantyStartDate" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold small text-uppercase">@T("warrantyEndDate")</label>
                                <input type="date" class="form-control" @bind="model.WarrantyEndDate" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Information -->
                <div class="card mb-4 border shadow-sm">
                    <div class="card-header bg-primary-subtle d-flex align-items-center gap-2">
                        <i class="bi bi-info-square fs-5"></i>
                        <span class="fw-bold">@T("additionalInfo")</span>
                    </div>
                    <div class="card-body p-4">
                        <!-- Equipment -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label fw-semibold mb-0">@T("equipment")</label>
                                <button type="button" class="btn btn-primary btn-sm" @onclick="AddEquipment">
                                    <i class="bi bi-plus-circle me-1"></i> @T("addEquipment")
                                </button>
                            </div>
                            @if (model.Equipment.Count == 0)
                            {
                                <div class="text-center text-muted py-4 bg-body-secondary border rounded-2">
                                    <i class="bi bi-tools display-4 opacity-25"></i>
                                    <p class="mt-2 mb-0 small">@T("noItems")</p>
                                </div>
                            }
                            else
                            {
                                <div class="d-flex flex-column gap-2">
                                    @foreach (var eq in model.Equipment)
                                    {
                                        <div class="d-flex gap-2 p-3 bg-body-secondary border rounded-2 align-items-end">
                                            <div class="flex-grow-1">
                                                <label class="form-label small fw-semibold text-muted">@T("equipmentName")</label>
                                                <input type="text" class="form-control form-control-sm" @bind="eq.Name" placeholder='@T("equipmentName")' />
                                            </div>
                                            <div style="min-width: 120px;">
                                                <label class="form-label small fw-semibold text-muted">@T("quantity")</label>
                                                <input type="number" class="form-control form-control-sm" @bind="eq.Quantity" min="1" />
                                            </div>
                                            <button type="button" class="btn btn-danger btn-sm" @onclick="() => RemoveEquipment(eq)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    }
                                </div>
                            }
                        </div>

                        <!-- Fixes -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label fw-semibold mb-0">@T("itemFix")</label>
                                <button type="button" class="btn btn-primary btn-sm" @onclick="AddFix">
                                    <i class="bi bi-plus-circle me-1"></i> @T("addFix")
                                </button>
                            </div>
                            @if (model.Fixes.Count == 0)
                            {
                                <div class="text-center text-muted py-4 bg-body-secondary border rounded-2">
                                    <i class="bi bi-gear display-4 opacity-25"></i>
                                    <p class="mt-2 mb-0 small">@T("noItems")</p>
                                </div>
                            }
                            else
                            {
                                <div class="d-flex flex-column gap-2">
                                    @foreach (var fix in model.Fixes)
                                    {
                                        <div class="d-flex gap-2 p-3 bg-body-secondary border rounded-2 align-items-end">
                                            <div style="min-width: 200px;">
                                                <label class="form-label small fw-semibold text-muted">@T("fixName")</label>
                                                <input type="text" class="form-control form-control-sm" @bind="fix.Name" placeholder='@T("fixName")' />
                                            </div>
                                            <div class="flex-grow-1">
                                                <label class="form-label small fw-semibold text-muted">@T("fixDescription")</label>
                                                <input type="text" class="form-control form-control-sm" @bind="fix.Description" placeholder='@T("fixDescription")' />
                                            </div>
                                            <button type="button" class="btn btn-danger btn-sm" @onclick="() => RemoveFix(fix)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    }
                                </div>
                            }
                        </div>

                        <!-- Work Order Notes -->
                        <div>
                            <label class="form-label fw-semibold small text-uppercase">@T("workOrderNotes")</label>
                            <textarea class="form-control" rows="4" @bind="model.WorkOrderNotes" placeholder='@T("notesPlaceholder")'></textarea>
                        </div>
                    </div>
                </div>

                <!-- BOQ Items -->
                <div class="card border shadow-sm">
                    <div class="card-header bg-primary-subtle d-flex align-items-center gap-2">
                        <i class="bi bi-list-check fs-5"></i>
                        <span class="fw-bold">@T("boqItems")</span>
                    </div>
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label class="form-label fw-semibold mb-0">@T("boqItems")</label>
                            <button type="button" class="btn btn-primary btn-sm" @onclick="AddBoqItem">
                                <i class="bi bi-plus-circle me-1"></i> @T("addBoqItem")
                            </button>
                        </div>
                        @if (model.BoqItems.Count == 0)
                        {
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-inbox display-1 opacity-25"></i>
                                <p class="mt-2">@T("noItems")</p>
                            </div>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-hover table-bordered align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="fw-semibold small text-uppercase">@T("itemDesc")</th>
                                            <th class="fw-semibold small text-uppercase">@T("itemCode")</th>
                                            <th class="fw-semibold small text-uppercase">@T("unit")</th>
                                            <th class="fw-semibold small text-uppercase">@T("qty")</th>
                                            <th class="fw-semibold small text-uppercase">@T("prevExec")</th>
                                            <th class="fw-semibold small text-uppercase">@T("execQty")</th>
                                            <th class="fw-semibold small text-uppercase">@T("actions")</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in model.BoqItems)
                                        {
                                            <tr>
                                                <td><input type="text" class="form-control form-control-sm" @bind="item.Desc" placeholder='@T("itemDesc")' /></td>
                                                <td><input type="text" class="form-control form-control-sm" @bind="item.Code" placeholder='@T("itemCode")' /></td>
                                                <td><input type="text" class="form-control form-control-sm" @bind="item.Unit" placeholder="m²" /></td>
                                                <td><input type="number" class="form-control form-control-sm" @bind="item.Qty" /></td>
                                                <td><input type="number" class="form-control form-control-sm" @bind="item.PrevExec" /></td>
                                                <td><input type="number" class="form-control form-control-sm" @bind="item.ExecQty" /></td>
                                                <td>
                                                    <button type="button" class="btn btn-danger btn-sm" @onclick="() => RemoveBoqItem(item)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        else if (activeTab == "attachments")
        {
            <div class="p-3">
                <div class="card border shadow-sm">
                    <div class="card-header bg-primary-subtle d-flex align-items-center gap-2">
                        <i class="bi bi-paperclip fs-5"></i>
                        <span class="fw-bold">@T("attachmentsTitle")</span>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="text-center p-4 bg-body-secondary border border-2 border-dashed rounded-3">
                                    <!-- CHANGED: inline white -> .icon-badge -->
                                    <div class="icon-badge d-flex justify-content-center align-items-center mb-3">
                                        <i class="bi bi-file-earmark-pdf text-primary display-6"></i>
                                    </div>
                                    <label class="fw-semibold d-block mb-3">@T("projectPlan")</label>
                                    <button type="button" class="btn btn-primary btn-sm w-100">
                                        <i class="bi bi-upload me-1"></i> @T("selectFile")
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center p-4 bg-body-secondary border border-2 border-dashed rounded-3">
                                    <div class="icon-badge d-flex justify-content-center align-items-center mb-3">
                                        <i class="bi bi-file-earmark-image text-primary display-6"></i>
                                    </div>
                                    <label class="fw-semibold d-block mb-3">@T("imageBefore")</label>
                                    <button type="button" class="btn btn-primary btn-sm w-100">
                                        <i class="bi bi-upload me-1"></i> @T("selectFile")
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center p-4 bg-body-secondary border border-2 border-dashed rounded-3">
                                    <div class="icon-badge d-flex justify-content-center align-items-center mb-3">
                                        <i class="bi bi-file-earmark-image text-primary display-6"></i>
                                    </div>
                                    <label class="fw-semibold d-block mb-3">@T("imageAfter")</label>
                                    <button type="button" class="btn btn-primary btn-sm w-100">
                                        <i class="bi bi-upload me-1"></i> @T("selectFile")
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center p-4 bg-body-secondary border border-2 border-dashed rounded-3">
                                    <div class="icon-badge d-flex justify-content-center align-items-center mb-3">
                                        <i class="bi bi-map text-primary display-6"></i>
                                    </div>
                                    <label class="fw-semibold d-block mb-3">@T("mapKey")</label>
                                    <button type="button" class="btn btn-primary btn-sm w-100">
                                        <i class="bi bi-upload me-1"></i> @T("selectFile")
                                    </button>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="text-center p-4 bg-body-secondary border border-2 border-dashed rounded-3">
                                    <div class="icon-badge d-flex justify-content-center align-items-center mb-3">
                                        <i class="bi bi-file-earmark text-primary display-6"></i>
                                    </div>
                                    <label class="fw-semibold d-block mb-3">@T("otherDoc")</label>
                                    <button type="button" class="btn btn-primary btn-sm">
                                        <i class="bi bi-upload me-1"></i> @T("selectFile")
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else if (activeTab == "workflow")
        {
            <div class="p-3">
                <div class="card border shadow-sm">
                    <div class="card-header bg-primary-subtle d-flex align-items-center gap-2">
                        <i class="bi bi-clock-history fs-5"></i>
                        <span class="fw-bold">@T("workflowHistoryTitle")</span>
                    </div>
                    <div class="card-body p-4">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-inbox display-1 opacity-25"></i>
                            <p class="mt-2">@T("noHistory")</p>
                        </div>
                    </div>
                </div>
            </div>
        }
    </EditForm>
</div>
