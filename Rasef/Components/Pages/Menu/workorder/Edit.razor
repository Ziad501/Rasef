@page "/workorder/edit/{id:int}"
@using Rasef.Resources.Localization
@using Microsoft.AspNetCore.Components.Forms
@layout MainLayout
@inject NavigationManager Nav
@inject IStringLocalizer<Strings> L
@inject CultureService Culture
@implements IDisposable

@code {
    protected override void OnInitialized()
    {
        Culture.OnChange += HandleCultureChanged;
        base.OnInitialized();
    }

    private void HandleCultureChanged() => InvokeAsync(StateHasChanged);
    public void Dispose() => Culture.OnChange -= HandleCultureChanged;

    [Parameter] public int id { get; set; }

    private EditVM vm = new();

    protected override void OnParametersSet()
    {
        vm = new EditVM
        {
            Number = $"WO-2025-{id:000}",
            Type = "Normal",
            Status = "Approved",
            Municipality = "جدة / Jeddah",
            Street = "Prince Mohammed Bin Abdulaziz St.",
            Created = new DateTime(2025, 01, 20),
            Notes = ""
        };
    }

    private void Save() => Nav.NavigateTo($"/workorder/details/{id}");
    private void Cancel() => Nav.NavigateTo("/workorder/workflow");

    public class EditVM
    {
        public string Number { get; set; } = "";
        public string Type { get; set; } = "Normal";
        public string Status { get; set; } = "PendingReview";
        public string Municipality { get; set; } = "";
        public string Street { get; set; } = "";
        public DateTime Created { get; set; } = DateTime.Today;
        public string Notes { get; set; } = "";
    }
}

<div dir="@(Culture.IsArabic ? "rtl" : "ltr")">
    <!-- Header / Actions -->
    <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
        <div>
            <h3 class="m-0 fw-bold">@L["title_edit"]</h3>
            <p class="text-muted small mb-0">@L["subtitle_edit"]</p>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-primary" @onclick="Save">
                <i class="bi bi-save me-2"></i> @L["save"]
            </button>
            <button class="btn btn-outline-secondary" @onclick="Cancel">
                <i class="bi bi-x-circle me-2"></i> @L["cancel"]
            </button>
        </div>
    </div>

    <!-- Form -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label small fw-semibold text-muted">@L["workOrderNumber"]</label>
                    <InputText class="form-control" @bind-Value="vm.Number" disabled />
                </div>

                <div class="col-md-4">
                    <label class="form-label small fw-semibold text-muted">@L["type"]</label>
                    <InputSelect class="form-select" @bind-Value="vm.Type">
                        <option value="Normal">@L["Normal"]</option>
                        <option value="ExceptionPriority">@L["ExceptionPriority"]</option>
                        <option value="ExceptionEmergency">@L["ExceptionEmergency"]</option>
                    </InputSelect>
                </div>

                <div class="col-md-4">
                    <label class="form-label small fw-semibold text-muted">@L["status"]</label>
                    <InputSelect class="form-select" @bind-Value="vm.Status">
                        <option value="PendingReview">@L["PendingReview"]</option>
                        <option value="Approved">@L["Approved"]</option>
                        <option value="Rejected">@L["Rejected"]</option>
                        <option value="InProgress">@L["InProgress"]</option>
                        <option value="Completed">@L["Completed"]</option>
                    </InputSelect>
                </div>

                <div class="col-md-4">
                    <label class="form-label small fw-semibold text-muted">@L["municipality"]</label>
                    <InputSelect class="form-select" @bind-Value="vm.Municipality">
                        <option>جدة / Jeddah</option>
                        <option>مكة / Mecca</option>
                        <option>الرياض / Riyadh</option>
                    </InputSelect>
                </div>

                <div class="col-md-5">
                    <label class="form-label small fw-semibold text-muted">@L["street"]</label>
                    <InputText class="form-control" @bind-Value="vm.Street" />
                </div>

                <div class="col-md-3">
                    <label class="form-label small fw-semibold text-muted">@L["createdDate"]</label>
                    <InputDate DateFormat="yyyy-MM-dd"
                               class="form-control"
                               @bind-Value="vm.Created" />
                </div>

                <div class="col-12">
                    <label class="form-label small fw-semibold text-muted">@L["notes"]</label>
                    <InputTextArea class="form-control" rows="4" @bind-Value="vm.Notes" />
                </div>
            </div>
        </div>

        <div class="card-footer d-flex justify-content-end gap-2">
            <button class="btn btn-primary" @onclick="Save">
                <i class="bi bi-save me-2"></i> @L["save"]
            </button>
            <button class="btn btn-outline-secondary" @onclick="Cancel">
                <i class="bi bi-x-circle me-2"></i> @L["cancel"]
            </button>
        </div>
    </div>
</div>
