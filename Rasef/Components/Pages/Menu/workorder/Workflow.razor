@page "/workorder/workflow"
@layout MainLayout
@using Rasef.Resources.Localization
@using Microsoft.AspNetCore.Components.Forms
@inject IStringLocalizer<Strings> L
@inject CultureService Culture
@inject NavigationManager Nav
@implements IDisposable

@code {
    protected override void OnInitialized()
    {
        Culture.OnChange += HandleCultureChanged;
        base.OnInitialized();
    }

    private void HandleCultureChanged() => InvokeAsync(StateHasChanged);
    public void Dispose() => Culture.OnChange -= HandleCultureChanged;

    private string search = "";
    private string status = "all";
    private string municipality = "all";

    private int currentPage = 1;
    private int pageSize = 10;
    private int[] pageSizeOptions = { 5, 10, 20, 50, 100 };

    // Wrapper properties to run "after" logic without @bind-Value:after
    private string Search
    {
        get => search;
        set { if (search != value) { search = value; currentPage = 1; } }
    }
    private string Status
    {
        get => status;
        set { if (status != value) { status = value; currentPage = 1; } }
    }
    private string Municipality
    {
        get => municipality;
        set { if (municipality != value) { municipality = value; currentPage = 1; } }
    }
    private int PageSize
    {
        get => pageSize;
        set { if (pageSize != value) { pageSize = value; currentPage = 1; } }
    }

    // Avoid collisions with other libraries' Row types (e.g., Keyboard.Row)
    private record WorkOrderRow(int Id, string Number, string Type, string Municipality, string Street, string Status, int Stage, DateTime Created);

    private readonly List<WorkOrderRow> data = new()
    {
        new(1,"WO-2025-001","Normal","جدة / Jeddah","شارع الأمير محمد بن عبدالعزيز","PendingReview",1,new DateTime(2025,1,20)),
        new(2,"WO-2025-002","ExceptionEmergency","مكة / Mecca","طريق الملك عبدالعزيز","InProgress",6,new DateTime(2025,1,18)),
        new(3,"WO-2025-003","ExceptionPriority","جدة / Jeddah","شارع التحلية","Approved",3,new DateTime(2025,1,22)),
        new(4,"WO-2025-004","Normal","الرياض / Riyadh","شارع العليا","Completed",7,new DateTime(2025,1,15)),
        new(5,"WO-2025-005","Normal","جدة / Jeddah","شارع فلسطين","PendingReview",2,new DateTime(2025,1,19)),
        new(6,"WO-2025-006","ExceptionPriority","مكة / Mecca","شارع الحج","InProgress",4,new DateTime(2025,1,17)),
        new(7,"WO-2025-007","Normal","الرياض / Riyadh","طريق الملك فهد","Approved",3,new DateTime(2025,1,21)),
        new(8,"WO-2025-008","ExceptionEmergency","جدة / Jeddah","شارع الأندلس","Rejected",2,new DateTime(2025,1,16)),
        new(9,"WO-2025-009","Normal","مكة / Mecca","طريق المدينة","Completed",7,new DateTime(2025,1,14)),
        new(10,"WO-2025-010","Normal","الرياض / Riyadh","شارع العروبة","InProgress",5,new DateTime(2025,1,23)),
        new(11,"WO-2025-011","ExceptionPriority","جدة / Jeddah","شارع الروضة","PendingReview",1,new DateTime(2025,1,24)),
        new(12,"WO-2025-012","Normal","مكة / Mecca","شارع العزيزية","Approved",4,new DateTime(2025,1,13)),
    };

    IEnumerable<WorkOrderRow> Filtered() => data
        .Where(r => string.IsNullOrWhiteSpace(search) ||
                    r.Number.Contains(search, StringComparison.OrdinalIgnoreCase) ||
                    r.Street.Contains(search, StringComparison.OrdinalIgnoreCase))
        .Where(r => status == "all" || r.Status == status)
        .Where(r => municipality == "all" || r.Municipality == municipality);

    IEnumerable<WorkOrderRow> Paginated()
    {
        var filtered = Filtered();
        return filtered.Skip((currentPage - 1) * pageSize).Take(pageSize);
    }

    int TotalPages() => (int)Math.Ceiling(Filtered().Count() / (double)pageSize);
    int TotalItems() => Filtered().Count();
    int StartItem() => TotalItems() == 0 ? 0 : (currentPage - 1) * pageSize + 1;
    int EndItem() { var end = currentPage * pageSize; var total = TotalItems(); return end > total ? total : end; }
    void GoToPage(int page) { if (page >= 1 && page <= TotalPages()) currentPage = page; }

    private static string TypeBadge(string type) => type switch
    {
        "Normal" => "bg-primary",
        "ExceptionPriority" => "bg-warning text-dark",
        "ExceptionEmergency" => "bg-danger",
        _ => "bg-secondary"
    };

    private static string StatusBadge(string s) => s switch
    {
        "PendingReview" => "bg-warning text-dark",
        "Approved" => "bg-success",
        "Rejected" => "bg-danger",
        "InProgress" => "bg-info text-dark",
        "Completed" => "bg-secondary",
        _ => "bg-secondary"
    };

    private static string StatusIcon(string s) => s switch
    {
        "PendingReview" => "bi-clock",
        "Approved" => "bi-check-circle",
        "Rejected" => "bi-x-circle",
        "InProgress" => "bi-arrow-repeat",
        "Completed" => "bi-check2-all",
        _ => "bi-circle"
    };
}

<div dir="@(Culture.IsArabic ? "rtl" : "ltr")">
    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
        <div>
            <h3 class="m-0 fw-bold">@L["workOrderTracking"]</h3>
            <p class="text-muted small mb-0">@L["trackingSubtitle"]</p>
        </div>
        <a href="/workorder/create" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i> @L["createWorkOrder"]
        </a>
    </div>

    <!-- Filters -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-lg-4 col-md-6">
                    <label class="form-label small fw-semibold text-muted">@L["search"]</label>
                    <div class="input-group">
                        <span class="input-group-text bg-transparent"><i class="bi bi-search"></i></span>
                        <InputText class="form-control"
                                   placeholder='@L["searchPlaceholder"]'
                                   @bind-Value="Search"
                                   @bind-Value:event="oninput" />
                    </div>
                </div>

                <div class="col-lg-4 col-md-6">
                    <label class="form-label small fw-semibold text-muted">@L["filterStatus"]</label>
                    <InputSelect class="form-select" @bind-Value="Status">
                        <option value="all">@L["all"]</option>
                        <option value="PendingReview">@L["PendingReview"]</option>
                        <option value="Approved">@L["Approved"]</option>
                        <option value="Rejected">@L["Rejected"]</option>
                        <option value="InProgress">@L["InProgress"]</option>
                        <option value="Completed">@L["Completed"]</option>
                    </InputSelect>
                </div>

                <div class="col-lg-4 col-md-6">
                    <label class="form-label small fw-semibold text-muted">@L["filterMunicipality"]</label>
                    <InputSelect class="form-select" @bind-Value="Municipality">
                        <option value="all">@L["all"]</option>
                        <option>جدة / Jeddah</option>
                        <option>مكة / Mecca</option>
                        <option>الرياض / Riyadh</option>
                    </InputSelect>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary + page size -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
        <span class="text-muted small">
            <i class="bi bi-list-check me-1"></i>
            @L["showing"] <strong>@StartItem()</strong> @L["to"] <strong>@EndItem()</strong>
            @L["of"] <strong>@TotalItems()</strong> @L["results"]
        </span>

        <div class="d-flex align-items-center gap-2">
            <label class="text-muted small mb-0">@L["itemsPerPage"]:</label>
            <InputSelect class="form-select form-select-sm w-auto" @bind-Value="PageSize">
                @foreach (var size in pageSizeOptions)
                {
                    <option value="@size">@size</option>
                }
            </InputSelect>
        </div>
    </div>

    <!-- Desktop table -->
    <div class="card shadow-sm mb-3">
        <div class="table-responsive d-none d-xl-block">
            <table class="table table-hover align-middle mb-0 workflow-table">
                <thead class="table-light">
                    <tr>
                        <th class="fw-semibold text-nowrap">@L["workOrderNumber"]</th>
                        <th class="fw-semibold text-nowrap">@L["type"]</th>
                        <th class="fw-semibold text-nowrap">@L["municipality"] / @L["street"]</th>
                        <th class="fw-semibold text-nowrap">@L["status"]</th>
                        <th class="fw-semibold text-nowrap">@L["currentStage"]</th>
                        <th class="fw-semibold text-nowrap">@L["createdDate"]</th>
                        <th class="fw-semibold text-center text-nowrap">@L["actions"]</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var r in Paginated())
                    {
                        <tr>
                            <td class="fw-semibold text-primary">@r.Number</td>
                            <td><span class="badge @TypeBadge(r.Type)">@L[r.Type]</span></td>
                            <td>
                                <div class="small text-muted">@r.Municipality</div>
                                <div class="text-truncate">@r.Street</div>
                            </td>
                            <td>
                                <span class="badge @StatusBadge(r.Status)">
                                    <i class="bi @StatusIcon(r.Status) me-1"></i> @L[r.Status]
                                </span>
                            </td>
                            <td><StageProgress CurrentStageIndex="@r.Stage" /></td>
                            <td class="text-muted"><i class="bi bi-calendar3 me-1"></i> @r.Created.ToString("yyyy-MM-dd")</td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group" aria-label="Actions">
                                    <a class="btn btn-outline-secondary" href="/workorder/edit/@r.Id">
                                        <i class="bi bi-pencil-square me-1"></i> @L["edit"]
                                    </a>
                                    <a class="btn btn-outline-primary" href="/workorder/details/@r.Id">
                                        <i class="bi bi-eye me-1"></i> @L["viewDetails"]
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }

                    @if (!Paginated().Any())
                    {
                        <tr>
                            <td colspan="7" class="text-center text-muted py-5">
                                <i class="bi bi-inbox fs-1 opacity-50"></i>
                                <p class="mt-2 mb-0">@L["noResults"]</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Mobile cards -->
        <div class="d-xl-none p-2">
            @foreach (var r in Paginated())
            {
                <div class="card shadow-sm mb-3 workflow-card">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <span class="fw-semibold text-primary">@r.Number</span>
                        <span class="badge @TypeBadge(r.Type)">@L[r.Type]</span>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 row-cols-1 row-cols-sm-2">
                            <div class="col">
                                <div class="fw-semibold small text-muted">@L["municipality"] / @L["street"]</div>
                                <div class="small text-muted">@r.Municipality</div>
                                <div class="fw-medium">@r.Street</div>
                            </div>
                            <div class="col">
                                <div class="fw-semibold small text-muted">@L["status"]</div>
                                <span class="badge @StatusBadge(r.Status)">
                                    <i class="bi @StatusIcon(r.Status) me-1"></i> @L[r.Status]
                                </span>
                            </div>
                            <div class="col">
                                <div class="fw-semibold small text-muted">@L["createdDate"]</div>
                                <div class="text-muted">
                                    <i class="bi bi-calendar3 me-1"></i> @r.Created.ToString("yyyy-MM-dd")
                                </div>
                            </div>
                            <div class="col">
                                <div class="fw-semibold small text-muted">@L["actions"]</div>
                                <div class="d-grid gap-2">
                                    <a class="btn btn-sm btn-outline-secondary" href="/workorder/edit/@r.Id">
                                        <i class="bi bi-pencil-square me-1"></i> @L["edit"]
                                    </a>
                                    <a class="btn btn-sm btn-outline-primary" href="/workorder/details/@r.Id">
                                        <i class="bi bi-eye me-1"></i> @L["viewDetails"]
                                    </a>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="fw-semibold small text-muted mb-2">@L["currentStage"]</div>
                                <StageProgress CurrentStageIndex="@r.Stage" />
                            </div>
                        </div>
                    </div>
                </div>
            }

            @if (!Paginated().Any())
            {
                <div class="text-center text-muted py-5">
                    <i class="bi bi-inbox fs-1 opacity-50"></i>
                    <p class="mt-2 mb-0">@L["noResults"]</p>
                </div>
            }
        </div>
    </div>

    <!-- Pagination -->
    @if (TotalPages() > 1)
    {
        <div class="d-flex justify-content-center">
            <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm mb-0 gap-1">
                    <li class="page-item @(currentPage == 1 ? "disabled" : null)">
                        <button class="page-link" @onclick="() => GoToPage(currentPage - 1)">
                            <i class="bi bi-chevron-left"></i>
                            <span class="d-none d-sm-inline ms-1">@L["previous"]</span>
                        </button>
                    </li>

                    @if (TotalPages() <= 7)
                    {
                        @for (int i = 1; i <= TotalPages(); i++)
                        {
                            var pageNum = i;
                            <li class="page-item @(currentPage == pageNum ? "active" : null)">
                                <button class="page-link" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                            </li>
                        }
                    }
                    else
                    {
                        <li class="page-item @(currentPage == 1 ? "active" : null)">
                            <button class="page-link" @onclick="() => GoToPage(1)">1</button>
                        </li>

                        @if (currentPage > 3)
                        {
                            <li class="page-item disabled"><span class="page-link">…</span></li>
                        }

                        @for (int i = Math.Max(2, currentPage - 1); i <= Math.Min(TotalPages() - 1, currentPage + 1); i++)
                        {
                            var pageNum = i;
                            <li class="page-item @(currentPage == pageNum ? "active" : null)">
                                <button class="page-link" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                            </li>
                        }

                        @if (currentPage < TotalPages() - 2)
                        {
                            <li class="page-item disabled"><span class="page-link">…</span></li>
                        }

                        <li class="page-item @(currentPage == TotalPages() ? "active" : null)">
                            <button class="page-link" @onclick="() => GoToPage(TotalPages())">@TotalPages()</button>
                        </li>
                    }

                    <li class="page-item @(currentPage == TotalPages() ? "disabled" : null)">
                        <button class="page-link" @onclick="() => GoToPage(currentPage + 1)">
                            <span class="d-none d-sm-inline me-1">@L["next"]</span>
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
    }
</div>
